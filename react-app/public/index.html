<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Musk Monitor</title>
<style>
:root{--primary:#3b82f6;--bg:#f0f9ff;--bg-card:#fff;--text:#1e293b;--text-muted:#94a3b8;--border:#e2e8f0;--green:#10b981;--red:#ef4444}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:-apple-system,sans-serif;height:100vh;overflow:hidden}
.sidebar{width:180px;background:var(--bg-card);border-right:1px solid var(--border);padding:16px;height:100vh;position:fixed;left:0;top:0;display:flex;flex-direction:column}
.logo{display:flex;align-items:center;gap:8px;margin-bottom:24px}
.logo-icon{width:32px;height:32px;background:linear-gradient(135deg,#3b82f6,#06b6d4);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff}
.logo-text{font-size:16px;font-weight:700;color:var(--primary)}
.menu-item{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;color:var(--text-muted);margin-bottom:3px;cursor:pointer;border:none;background:none;width:100%;text-align:left;font-size:13px}
.menu-item:hover{background:var(--bg)}
.menu-item.active{background:linear-gradient(135deg,var(--primary),#60a5fa);color:#fff}
.status{margin-top:auto;padding:10px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);border-radius:8px}
.status-dot{width:6px;height:6px;background:var(--green);border-radius:50%;display:inline-block;margin-right:6px}
.main{margin-left:180px;height:100vh;overflow-y:auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
h1{font-size:20px;font-weight:700}
.update-time{color:var(--text-muted);font-size:11px;font-family:monospace;background:var(--bg-card);padding:4px 8px;border-radius:4px;border:1px solid var(--border)}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.stat-card{background:var(--bg-card);border-radius:10px;padding:14px;border:1px solid var(--border)}
.stat-value{font-size:22px;font-weight:700}
.stat-label{color:var(--text-muted);font-size:10px;margin-top:2px}
.card{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:14px;border:1px solid var(--border)}
.card-title{font-size:13px;font-weight:600;margin-bottom:10px}
.chart{height:120px;padding:10px 0;display:flex;align-items:flex-end;gap:8px;position:relative}
.line-chart{height:120px;padding:10px 0;position:relative}
.line-point{position:absolute;width:8px;height:8px;background:var(--primary);border-radius:50%;bottom:0;transform:translateX(-50%)}
.line-dot{position:absolute;width:6px;height:6px;background:#fff;border:2px solid var(--primary);border-radius:50%;bottom:0;transform:translateX(-50%);z-index:2}
.line-label{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);font-size:9px;color:var(--text-muted)}
.line-connector{position:absolute;bottom:0;height:2px;background:var(--primary);transform-origin:left center}
.poly-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.poly-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px}
.poly-rank{background:var(--primary);color:#fff;padding:2px 5px;border-radius:3px;font-size:9px}
.poly-date{color:var(--text-muted);font-size:10px}
.poly-title{font-size:11px;font-weight:600;margin:6px 0;line-height:1.3}
.poly-vol{display:flex;justify-content:space-between;font-size:10px;margin-bottom:6px}
.total-vol{background:linear-gradient(135deg,var(--primary),#06b6d4);color:#fff;padding:5px 10px;border-radius:6px;font-size:11px;font-weight:600}
.loading{text-align:center;padding:30px;color:var(--text-muted)}
.pred-box{background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(6,182,212,0.05));border:1px solid rgba(16,185,129,0.3);border-radius:12px;padding:14px;margin-bottom:14px}
.pred-title{font-size:13px;font-weight:600;color:var(--green);margin-bottom:10px}
.pred-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.pred-item{text-align:center}
.pred-value{font-size:24px;font-weight:700}
.pred-label{font-size:10px;color:var(--text-muted);margin-top:2px}
.trend-up{color:var(--green)}
.trend-down{color:var(--red)}
.heatmap{display:grid;grid-template-columns:repeat(24,1fr);gap:2px;margin-top:10px}
.heat-cell{height:24px;border-radius:3px;position:relative}
.heat-label{position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);font-size:7px;color:var(--text-muted)}
table{width:100%;border-collapse:collapse;font-size:11px}
th{text-align:left;padding:6px;color:var(--text-muted);font-size:10px;border-bottom:2px solid var(--border)}
td{padding:6px;border-bottom:1px solid var(--border)}
</style>
</head>
<body>
<div class="sidebar">
<div class="logo"><div class="logo-icon">ğŸ¯</div><span class="logo-text">MUSK MONITOR</span></div>
<button class="menu-item active" id="btn-dash">ğŸ“Š å®æ—¶æ¦‚è§ˆ</button>
<button class="menu-item" id="btn-backend">ğŸ“Š åç«¯æ•°æ®</button>
<button class="menu-item" id="btn-poly">ğŸ¯ é¢„æµ‹å¸‚åœº</button>
<div class="status"><span class="status-dot"></span><span style="font-size:11px;color:var(--green)">è¿è¡Œä¸­</span></div>
</div>
<div class="main" id="main"><div class="loading">åŠ è½½ä¸­...</div></div>

<script>
var tweetData = {};
var polyData = [];
var predData = {};

function loadData() {
  Promise.all([
    fetch('/api'),
    fetch('/api/polymarket'),
    fetch('/api/prediction')
  ]).then(function(responses) {
    return Promise.all(responses.map(function(r) { return r.json(); }));
  }).then(function(data) {
    tweetData = data[0] || {};
    polyData = (data[1] && data[1].markets) ? data[1].markets : [];
    predData = data[2] || {};
    showDashboard();
  }).catch(function(e) {
    console.error(e);
    showDashboard();
  });
}

function showDashboard() {
  setActive('btn-dash');
  var daily = [];
  if (tweetData.daily) {
    var entries = Object.entries(tweetData.daily);
    entries.sort(function(a, b) { return a[0].localeCompare(b[0]); });
    daily = entries.slice(-14);
  }
  var latest = daily.length > 0 ? daily[daily.length - 1] : null;
  var maxCount = Math.max.apply(null, daily.map(function(d) { return d[1].count; }).concat([1]));
  var totalVol = polyData.reduce(function(s, m) { return s + (m.volume || 0); }, 0);
  
  var predHtml = '';
  if (predData.tomorrow_pred) {
    var trendClass = predData.trend_pct > 0 ? 'trend-up' : (predData.trend_pct < 0 ? 'trend-down' : '');
    predHtml = '<div class="pred-box">' +
      '<div class="pred-title">ğŸ¯ AI é¢„æµ‹</div>' +
      '<div class="pred-grid">' +
        '<div class="pred-item"><div class="pred-value">' + predData.tomorrow_pred + '</div><div class="pred-label">æ˜æ—¥</div></div>' +
        '<div class="pred-item"><div class="pred-value">' + predData.week_pred + '</div><div class="pred-label">æœ¬å‘¨</div></div>' +
        '<div class="pred-item"><div class="pred-value ' + trendClass + '">' + (predData.trend || '-').replace('ğŸ“ˆ ','').replace('ğŸ“‰ ','').replace('â¡ï¸ ','') + '</div><div class="pred-label">' + ((predData.trend_pct || 0) > 0 ? '+' : '') + (predData.trend_pct || 0) + '%</div></div>' +
      '</div></div>';
  }
  
  var updateTime = tweetData.last_updated ? tweetData.last_updated.slice(0, 16) : '';
  
  // æŠ˜çº¿å›¾
  var lineHtml = '';
  if (daily.length > 0) {
    var minVal = Math.min.apply(null, daily.map(function(d) { return d[1].count; }));
    var maxVal = Math.max.apply(null, daily.map(function(d) { return d[1].count; }));
    var range = maxVal - minVal || 1;
    
    daily.forEach(function(d, i) {
      var pct = ((d[1].count - minVal) / range) * 80;
      lineHtml += '<div style="flex:1;position:relative;height:100%;display:flex;align-items:flex-end;"><div class="line-dot" style="bottom:' + pct + 'px"></div><div class="line-label">' + d[0].slice(5) + '</div></div>';
    });
  }
  
  var html = '<div class="header"><h1>ğŸ“Š å®æ—¶æ¦‚è§ˆ</h1><span class="update-time">' + updateTime + '</span></div>' +
    predHtml +
    '<div class="stats-grid">' +
      '<div class="stat-card"><div class="stat-value">' + (latest ? latest[1].count : 0) + '</div><div class="stat-label">ä»Šæ—¥æ¨æ–‡</div></div>' +
      '<div class="stat-card"><div class="stat-value">' + (tweetData.total_tweets || 0) + '</div><div class="stat-label">æ€»æ¨æ–‡</div></div>' +
      '<div class="stat-card"><div class="stat-value">' + daily.length + '</div><div class="stat-label">æ•°æ®å¤©æ•°</div></div>' +
      '<div class="stat-card"><div class="stat-value">$' + (totalVol / 1000000).toFixed(1) + 'M</div><div class="stat-label">å¸‚åœºæ€»é‡</div></div>' +
    '</div>' +
    '<div class="card"><div class="card-title">ğŸ“ˆ æ¨æ–‡è¶‹åŠ¿ (æŠ˜çº¿å›¾)</div><div class="line-chart" style="display:flex;align-items:flex-end;gap:10px;height:100px;">' + lineHtml + '</div></div>';
  
  document.getElementById('main').innerHTML = html;
}

function showBackend() {
  setActive('btn-backend');
  var tweets = [];
  if (tweetData.daily) {
    Object.entries(tweetData.daily).forEach(function(item) {
      var date = item[0];
      var info = item[1];
      if (info.tweets) {
        info.tweets.forEach(function(t) {
          tweets.push({
            date: date,
            time: t.time ? t.time.slice(11, 19) : '',
            hour: t.time ? parseInt(t.time.slice(11, 13)) || 0 : 0,
            content: t.content || ''
          });
        });
      }
    });
  }
  tweets.sort(function(a, b) { return (a.time || '').localeCompare(b.time || ''); });
  
  var hourlyCounts = new Array(24).fill(0);
  tweets.forEach(function(t) { if (t.hour >= 0 && t.hour < 24) hourlyCounts[t.hour]++; });
  var maxHour = Math.max.apply(null, hourlyCounts.concat([1]));
  
  var dailyCounts = {};
  tweets.forEach(function(t) { dailyCounts[t.date] = (dailyCounts[t.date] || 0) + 1; });
  var dailyArr = Object.entries(dailyCounts).sort(function(a, b) { return a[0].localeCompare(b[0]); });
  var maxDaily = Math.max.apply(null, dailyArr.map(function(d) { return d[1]; }).concat([1]));
  
  var totalTweets = tweets.length;
  var avgDaily = (totalTweets / Math.max(Object.keys(dailyCounts).length, 1)).toFixed(1);
  var peakHour = hourlyCounts.indexOf(Math.max.apply(null, hourlyCounts));
  
  var heatmapHtml = '<div class="heatmap">';
  for (var h = 0; h < 24; h++) {
    var intensity = hourlyCounts[h] / maxHour;
    var color = 'rgba(59,130,246,' + (0.1 + intensity * 0.9) + ')';
    heatmapHtml += '<div class="heat-cell" style="background:' + color + '" title="' + h + ':00 - ' + hourlyCounts[h] + 'æ¡"><span class="heat-label">' + h + '</span></div>';
  }
  heatmapHtml += '</div>';
  
  var html = '<div class="header"><h1>ğŸ“Š åç«¯æ•°æ®</h1></div>' +
    '<div class="stats-grid" style="grid-template-columns:repeat(5,1fr);">' +
      '<div class="stat-card"><div class="stat-value">' + totalTweets + '</div><div class="stat-label">æ€»æ¨æ–‡</div></div>' +
      '<div class="stat-card"><div class="stat-value">' + avgDaily + '</div><div class="stat-label">æ—¥å‡</div></div>' +
      '<div class="stat-card"><div class="stat-value">' + peakHour + ':00</div><div class="stat-label">é«˜å³°æ—¶æ®µ</div></div>' +
      '<div class="stat-card"><div class="stat-value">' + Math.max.apply(null, dailyArr.map(function(d) { return d[1]; })) + '</div><div class="stat-label">æœ€é«˜å•æ—¥</div></div>' +
      '<div class="stat-card"><div class="stat-value">' + Object.keys(dailyCounts).length + '</div><div class="stat-label">æ•°æ®å¤©æ•°</div></div>' +
    '</div>' +
    '<div class="card"><div class="card-title">ğŸ• æ—¶æ®µçƒ­åŠ›å›¾ (24å°æ—¶)</div>' + heatmapHtml + '</div>' +
    '<div class="card"><div class="card-title">ğŸ“‹ åŸå§‹æ•°æ® (' + tweets.length + 'æ¡)</div><table><tr><th>æ—¥æœŸ</th><th>æ—¶é—´</th><th>å†…å®¹</th></tr>' +
    tweets.slice(0, 30).map(function(t) { 
      return '<tr><td>' + t.date + '</td><td style="font-family:monospace;">' + t.time + '</td><td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + t.content + '">' + t.content + '</td></tr>'; 
    }).join('') + 
    '</table></div>';
  
  document.getElementById('main').innerHTML = html;
}

function showPolymarket() {
  setActive('btn-poly');
  var totalVol = polyData.reduce(function(s, m) { return s + (m.volume || 0); }, 0);
  var top6 = polyData.slice(0, 6);
  
  if (top6.length === 0) {
    document.getElementById('main').innerHTML = '<div class="header"><h1>ğŸ¯ é¢„æµ‹å¸‚åœº</h1></div><div class="card"><p style="text-align:center;padding:30px;color:var(--text-muted)">åŠ è½½ä¸­...</p></div>';
    return;
  }
  
  var html = '<div class="header"><h1>ğŸ¯ é¢„æµ‹å¸‚åœº</h1><span class="total-vol">$' + (totalVol / 1000000).toFixed(2) + 'M</span></div>' +
    '<div class="poly-grid">' +
    top6.map(function(m, i) {
      var outcomesHtml = '';
      if (m.outcomes) {
        outcomesHtml = '<div style="margin-bottom:6px;"><div style="font-size:9px;color:var(--text-muted);margin-bottom:4px;">äººä»¬è®¤ä¸ºæœ€å¯èƒ½:</div>' +
          m.outcomes.slice(0, 5).map(function(o) {
            return '<div style="display:flex;justify-content:space-between;padding:2px 4px;background:var(--bg);border-radius:2px;margin-bottom:2px;font-size:10px;"><span>' + o.outcome + '</span><span style="color:var(--green);font-weight:600">Yes ' + o.pct + '</span></div>';
          }).join('') + '</div>';
      }
      return '<div class="poly-card"><div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span class="poly-rank">#' + (i+1) + '</span><span class="poly-date">' + (m.end_date || '') + '</span></div><div class="poly-title">' + (m.title || '') + '</div><div class="poly-vol"><span style="color:var(--text-muted)">äº¤æ˜“é‡</span><span style="font-weight:700">' + (m.volume_display || '') + '</span></div>' + outcomesHtml + '<a href="' + (m.url || '#') + '" target="_blank" style="display:block;text-align:center;background:var(--primary);color:#fff;padding:6px;border-radius:4px;text-decoration:none;font-size:11px;font-weight:600;">æŸ¥çœ‹ â†’</a></div>';
    }).join('') +
    '</div>';
  
  document.getElementById('main').innerHTML = html;
}

function setActive(id) {
  document.querySelectorAll('.menu-item').forEach(function(el) { el.classList.remove('active'); });
  document.getElementById(id).classList.add('active');
}

document.getElementById('btn-dash').onclick = showDashboard;
document.getElementById('btn-backend').onclick = showBackend;
document.getElementById('btn-poly').onclick = showPolymarket;

loadData();
</script>
</body>
</html>
